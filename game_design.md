# 生态系统模拟游戏需求文档

## 1. 核心设计
### 1.1 游戏概述
游戏采用2d平面表现方式，玩家通过投放实体来维持生态平衡。
### 1.3 地图系统
- 网格规格：
  - 最小尺寸：4x4
  - 最大尺寸：256x256
  - 默认初始尺寸：9x9
- 单元格规则：
  - 容量限制：
    - 0-1株植物
    - 0-1只动物
    - 允许植物与动物共存
  - 状态标识：
    - 地形类型（预留扩展）
    - 实体占用标记
- 可视化要求：
  - 网格线可见
  - 实体占位高亮显示
  - 状态提示悬浮窗
  - 视口导航：
    - 基础模式：鼠标拖拽平移（按住左键拖动）
    - 备选模式：边缘触发滚动（鼠标靠近窗口边缘时自动平移）
    - 辅助功能：
      - 小地图导航
      - 双击聚焦选中实体
      - 滚轮缩放（可选）
- 性能规范：
  - 视口外实体休眠
  - 动态加载半径：3倍视口尺寸

### 1.1 游戏概述
- 类型：策略型生态系统模拟
- 模式：关卡制线性推进（50关）
- 核心玩法：通过投放实体维持生态平衡

### 1.2 核心系统
#### 关卡系统
- 线性解锁机制（完成N关解锁N+1）
- 关卡选择界面需显示：
  - 关卡目标
  - 历史最高评分
  - 解锁状态

#### 实体系统
| 实体类型 | 属性                 | 行为规则                                                                 |
|----------|----------------------|--------------------------------------------------------------------------|
| 草       | 生长阶段/播种概率    | 种子→(5s)→幼苗→(10s)→成熟→(20s)→枯萎                                    |
| 兔子     | 饱食度(0-10)/饥饿阈值 | 非饥饿状态：随机移动(2-5s间隔，相邻格)<br>饥饿状态：寻路移动(1格/s，A*算法)<br>进食速率1单位/s，消耗速率0.5单位/s |

#### 1.2.3 食物链系统
##### 数据结构
```typescript
interface FoodChain {
  id: string;
  version: "2.0"; // 结构版本标识
  nodes: {
    id: string;        // 节点唯一ID
    entity: string;    // 关联实体类型
    level: number;     // 食物链层级(1=生产者)
    position?: {       // 可视化坐标
      x: number;       // 水平位置(0-100)
      y: number;       // 垂直位置(0-100) 
    };
  }[];
  edges: {
    source: string;    // 源节点ID
    target: string;    // 目标节点ID
    energy: number;    // 能量转化率(0-1)
    branch?: boolean;  // 是否为分支路径
  }[];
  visual?: {
    color: string;
    thickness: number; // 连线粗细(px)
  };
}
```

##### 预置模板
1. **基础交叉链**：
```yaml
id: "chain_1"
version: "2.0"
nodes:
  - id: "n1"
    entity: "grass"
    level: 1
    position: {x: 30, y: 20}
  - id: "n2" 
    entity: "rabbit"
    level: 2
    position: {x: 20, y: 50}
  - id: "n3"
    entity: "fox"
    level: 3  
    position: {x: 30, y: 80}
  - id: "n4"
    entity: "locust"
    level: 2
    position: {x: 60, y: 50}
  - id: "n5"
    entity: "lizard"
    level: 3
    position: {x: 60, y: 80}
edges:
  - source: "n1"
    target: "n2"
    energy: 0.3
  - source: "n2"
    target: "n3" 
    energy: 0.2
  - source: "n1"
    target: "n4"
    energy: 0.25
    branch: true
  - source: "n4"
    target: "n5"
    energy: 0.15
visual:
  color: "#4CAF50"
  thickness: 2
```

2. **森林复合链**：
```yaml
id: "chain_2"
version: "2.0"  
nodes:
  - id: "n1"
    entity: "mushroom"
    level: 1
    position: {x: 20, y: 20}
  - id: "n2"
    entity: "snail"
    level: 2
    position: {x: 20, y: 50}
  - id: "n3"
    entity: "hedgehog"
    level: 3
    position: {x: 30, y: 80}
  - id: "n4"
    entity: "acorn"
    level: 1
    position: {x: 60, y: 20}
  - id: "n5"
    entity: "squirrel"
    level: 2
    position: {x: 60, y: 50}
edges:
  - source: "n1"
    target: "n2"
    energy: 0.4
  - source: "n2"
    target: "n3"
    energy: 0.3
  - source: "n4"
    target: "n5"
    energy: 0.35
  - source: "n5"
    target: "n3"
    energy: 0.25
    branch: true
visual:
  color: "#FF9800"
  thickness: 3
```

##### 配置规则
- 每个关卡可配置1-3条食物链
- 实体可跨链存在（如草可在多条链）
- 冲突时按priority决定显示优先级

##### 可视化规范
```typescript
interface FoodChainVisual {
  nodeRadius: number; // 节点半径(px)
  linkDistance: number; // 连接线长度
  colorScheme: {
    producer: string;   // 生产者颜色
    consumer: string;   // 消费者颜色
    apex: string;       // 顶级消费者颜色
  };
  animation: {
    energyFlow: {
      duration: number; // 能量流动动画时长(ms)
      interval: number; // 流动间隔(ms)
    };
  };
}
```

##### 生物参数表
| 实体 | 生长阶段            | 持续时间(s) | 环境需求          | 交互冷却(s) |
|-------|---------------------|-------------|-------------------|-------------|
| 草    | seed → sprout        | 5           | 光照>50%          | 10          |
|       | sprout → mature      | 10          |                   |             |
|       | mature → withered    | 20          |                   |             |
| 兔子  | hungry → searching   | 3           | 附近草密度>1/9格  | 5           |
|       | eating               | 2           |                   |             |

#### 玩家系统
- 积分池：每关固定初始值
- 操作卡片：
  - 种植草（消耗X分）
  - 投放兔子（消耗Y分）
  - 移除实体（免费）

## 2. 关卡设计
### 2.1 关卡模板
```yaml
关卡ID: 1
名称: "基础教学"
目标:
  类型: "维持生存" # 可选值: 维持生存/数量平衡/指定得分
  描述: "保持1只兔子存活60秒"
  参数: 
    目标实体: "rabbit"
    持续时间: 60
初始配置:
  地图: 
    尺寸: 9x9
    地形: {} # 预留扩展
  实体: 
    - 类型: "grass"
      状态: "mature"
      坐标: [4,4]
      生长阶段: 
        - 名称: "seed"
          持续时间: 5
        - 名称: "sprout"
          持续时间: 10
    - 类型: "rabbit"
      属性:
        饱食度: 7
        饥饿阈值: 6
      坐标: [2,3]
食物链: ["chain_1"] # 引用预置食物链ID
玩家:
  初始积分: 50
  操作冷却: 1.0 # 秒
卡片:
  草: 
    价格: 10
    最大持有: 5
  兔子:
    价格: 30
    投放范围: 3 # 投放半径(格)
解锁条件: null
```

### 2.2 关卡难度曲线
- 前10关：单物种平衡
- 11-30关：引入多物种竞争
- 31-50关：加入环境扰动因素

## 3. 数值设计
### 3.1 基础数值表
| 实体 | 属性            | 基准值 | 可调范围 |
|-------|-----------------|--------|----------|
| 草    | 成熟期持续时间  | 20s    | ±30%     |
| 兔子  | 饥饿阈值        | 6      | [5,7]    |

### 3.2 积分经济
- 每关积分总量 ≈ 预期操作次数 × 平均操作成本 × 1.2

## 4. 扩展接口
### 4.1 实体模板
=======
## 5. 数据驱动设计
### 5.1 配置系统架构
#### 文件结构
```
config/
  ├── entities/              # 实体配置
  │    ├── rabbit.json
  │    └── fox.json
  ├── levels/                # 关卡配置
  │    └── level01.json
  └── game_balance.json      # 全局平衡配置
```

#### 热重载机制
1. 开发环境自动监听文件变更
2. 生产环境通过管理员命令触发：
   ```bash
   POST /api/config/reload
   ```
3. 变更验证流程：
   - 语法校验 → 逻辑校验 → 应用生效

### 5.2 调试工具规范
#### 控制台命令
| 命令                | 功能                     | 示例                     |
|---------------------|--------------------------|--------------------------|
| /spawn [type] [x,y] | 生成实体                 | /spawn rabbit 2,3        |
| /set hunger [value] | 设置饥饿度               | /set hunger 5            |
| /speed [factor]     | 调整游戏速度             | /speed 2.5               |

#### 可视化辅助
1. 实体状态悬浮面板
2. 实时曲线图：
   - 种群数量变化
   - 资源消耗速率

### 5.3 测试方案
#### 自动化测试框架
```python
def test_ecosystem_balance():
    load_config('scenarios/high_density.json')
    result = simulate(hours=2)
    assert result.rabbit_count > 20, "兔子种群未达预期"
```

#### 性能指标
1. 单帧最大实体数 ≥500
2. 配置加载时间 <100ms
3. 状态计算延迟 <5ms

## 6. UI系统设计
```json
{
  "type": "plant",
  "states": [
    {"name": "seed", "duration": 5},
    {"name": "sprout", "duration": 10}
  ]
}
```

### 4.2 事件钩子
- OnEntitySpawn
- OnStateChange
- OnLevelComplete

## 5. UI系统设计
### 5.1 布局规范
```
+-----------------------------------------------------+
| [操作按钮区] [倍速控制] [状态/分数显示]             |
| (左上角)     (1x/2x/3x) (关卡/分数/时间)            |
+-----------------------------------------------------+
|                                                     |
|                 全屏地图展示区域                    |
|                  (网格化显示)                       |
|                                                     |
+-----------------------------------------------------+
| [投放选择控制区]                                    |
| (可滚动实体卡片，底部居中)                          |
+-----------------------------------------------------+
```

#### 区域说明
1. **顶部操作区**（固定高度60px）：
   - 操作按钮：开始/暂停/重置（图标化）
   - 倍速控制：1x/2x/3x切换按钮
   - 状态显示：当前关卡、分数、剩余时间

2. **全屏地图区域**：
   - 网格类型：平顶式六边形（偶行偏移半个单元）
   - 坐标系统：轴坐标(q,r)表示
   - 网格视觉：浅色半透明边线
   - 实体显示：带状态动画的精灵
   - 视口控制：
     - 拖拽平移
     - 滚轮缩放
     - 双击复位
   - 六边形规格：
     - 边长：60px
     - 单元高度：104px
     - 单元宽度：120px

3. **底部投放控制区**（固定高度120px）：
   - 可横向滚动的实体卡片
   - 卡片内容：实体图标+名称+消耗积分
   - 选中状态：高亮边框+放大效果

4. **浮动信息面板**：
   - 触发条件：点击地图实体时显示
   - 显示位置：实体附近智能避障
   - 关闭方式：
     - 面板关闭按钮
     - 点击面板外部
   - 内容：
     - 实体属性（生命值/状态等）
     - 关联食物链简图
     - 操作按钮（删除/升级）

### 5.2 交互流程
#### 实体投放流程
1. 在底部控制区选择实体卡片（高亮显示）
2. 点击地图网格目标位置：
   - 成功：播放特效，扣除积分
   - 失败：显示浮动提示（红色文字，2秒淡出）
3. 取消选择：
   - 点击已选卡片
   - 5秒无操作自动取消

#### 状态反馈规范
- 视觉反馈：
  - 投放成功：绿色粒子特效
  - 投放失败：红色闪烁提示
  - 积分不足：卡片灰显+抖动
- 音效反馈：
  - 卡片选择：轻击声
  - 投放成功：清脆音
  - 操作错误：低沉音

### 5.3 卡牌设计
```typescript
interface CardConfig {
  entityType: 'plant' | 'animal';
  displayName: string;
  cost: number;
  icon: string;
  maxUsage?: number; // 可选使用次数限制
}
```

### 5.3 状态反馈
- 视觉反馈：
  - 积分不足时卡牌变灰
  - 投放成功时地图格闪烁绿光
- 音效反馈：
  - 卡牌选择音
  - 投放成功音
  - 错误操作音